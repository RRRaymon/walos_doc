# 系统介绍
---------

WalOS分为几个子系统，包括:

1. 图像处理子系统: 集成有ISP调节算法，图像处理算法等；
2. AI算法子系统: 集成有人脸检测算法、人脸特征提取算法、人形检测算法、非机动机检测算法、车牌识别算法等视频结构化算法；
3. 控制子系统: 集成外设控制，包括刷卡、雷达、二维码读头、人体测温等模块，并可控制继电器、RS485接口外设、韦根口门禁、梯控等；
4. 管理子系统: 集成webapi服务，可对接智云平台、门禁控制器、企业微信以及大量第三方应用平台软件；
5. 交互子系统: 通过图形界面、语音、触摸屏等实现用用户的交互； 

## 管理模式

WalOS默认启动基于HTTP协议的WebAPI服务，默认端口号为80。同时可以根据配置，通过Websocket或MQTT协议接入云平台。

### 消息格式

典型的协议消息体：
- 请求， 服务器向设备发送请求（*注意 reqid 需  请求<=>响应 一一对应）*

```json
{
  "action": "device-info", // 1. 请求命令字
  "header":{               // 2. 消息头信息
    "reqid":"192839",      // 2.1 透传值，由请求方设置
    "devid":"001528D"      // 2.2 可选，请求设备ID
    },
    "body":{               
        // 3. 消息体，包括与命令字相关的消息内容，如果命令无消息内容则此项不存在
    }
}
```

- 响应，设备向服务器发送响应

```json
{
  "retcode":0,              // 1. 响应状态码，0 为成功，其它值为失败错误码，错误码见附录
  "header":{                // 2. 消息头信息
    "reqid":"192839",       // 2.1 透传值，返回请求时传过来的值。
    "devid":"001528D"       
  },
  "action": "device-info-ack", // 3. 返回的action
  // 4. 响应消息体
  "body":{                    
    "device-id":"device-id",            
    "hardware-version" : "v1.2.0",       
    "walos-version" : "v2.1.0",             
    "protocol-version": "v2.2.0",           
    "algm-vendor" : "xxxx",                
    "algm-version"  : "v1.1.0",            
  }
}
```

### WebAPI服务

- 1. 采用扫描程序，发现局域网内设备或通过固定IP地址连接设备，登陆设备；
- 2. 向设备发送http请求，设备接收请求、处理任务并返回处理结果；
- 3. 如果设备配置为***仅提供局域网api服务***模式，则设备向report-state-server提交运行告警事件、识别事件。

典型请求：

>请求URL: http://dev-ip-addr:port:/api/v3.x/device
>请求类型: POST
>HTTP头：访问Token，登陆时获取。在登陆前可获取设备信息（device-info指令）可不填写Token，其它指令必须填写登陆时返回的token值

## 行文约定

本文后续部分，主要为请求-响应的数据包格式，直接对应到mqtt的请求-响应，与WebAPI服务的请求-响应的内容基本上是一致的，仅仅是因为传输模式不同，与传输有关的地方有差异而已。  

